---
title: "EDA & modeling"
author: "Hao He"
date: "2023-02-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(tidyverse)
library(readxl)
library(scales)
library(forcats)
library(ggpubr)
library(lme4)
library(lmerTest)
library(performance)
library(PerformanceAnalytics)
library(tibble)
library(rstanarm)
```

Orangu    tans, in general, are semi-solitary given low fruit availability. But they do form associations during periods of high fruit availability. To understand if socializing could be stressful and how it contributes to the solitary/sociality activities, a bunch of situations where social stress may be incurred is explored. SDB as a measure of social anxiety.

# Load data

```{r load raw data, warning=FALSE}
sdb<- read_excel("SDB_Data for Stats Consult_O'Connell&Knott_2.17.23.xlsx",sheet = 1,col_names = T)

# check missing values: 
sdb %>% summarise_all(~(sum(is.na(.))))
# NA appears only on partner's info: name, age-sex
```

## Explore age-sex combination, count of each combination, and corresponding average SDB

```{r raw data}
# AveSDBEventID --  refers to the average sdb for each event

# sdb %>% add_count(`Age-Sex of Focal`, name = "count_AgeSex") %>% group_by(`Age-Sex of Focal`) %>% summarise(AvgSDB_AgeSex = mean(`SDB Rate`))

by_agesex<- sdb %>% group_by(`Age-Sex of Focal`) %>% summarise(n = n(),AvgSDB_AgeSex = mean(`SDB Rate`))
by_agesex
 
by_agesex %>% ggplot(aes(x = `Age-Sex of Focal`,y=AvgSDB_AgeSex, fill=`Age-Sex of Focal`)) +geom_bar( stat="identity") + labs(title = "Age-sex combination and corresponding average SDB", fill= "Age-Sex Category of Focal") 
  

```

# two predictions need to be validated with our EDA result

**Socializing effect** - Rate of SDB is higher when orangutans are social versus when they are alone.

```{r distinct event id}
by_social <- sdb %>% group_by(`Social Y or N`) %>% summarise(n = n(),AvgSDB_social = mean(`SDB Rate`))
 
sdb%>% ggplot(aes(x = `Social Y or N`,y=`SDB Rate`, fill=`Social Y or N`)) +geom_boxplot(fill ="slateblue",alpha = 0.2) + labs(title = "Social status of Focal and corresponding average SDB", fill= "Social status of Focal")
```

- For adolescent females, socializing with adult females or flanged males is associated with elevated SDB rate, while socializing with unflagged males or other adolescent females is associated with no change in rate of SDB.

```{r buffering effect}
social_AdolF<- sdb %>% filter(`Age-Sex of Focal` == "Adol Female" &`Social Y or N` == "Y") 
#  using combination of Focal and partner to check the frequency


```

# preprocess data
```{r}
# separate the age-sex category of Focal into two predictors
# better interpretability for intereaction term
sdb %>% 
  mutate(age = case_when(sdb$`Age-Sex of Focal` == "Adult Female" ~ "adult",
                         sdb$`Age-Sex of Focal` == "Adol Female" ~ "adol",
                         sdb$`Age-Sex of Focal` == "Flanged" ~ "adult",
                         TRUE ~ "adol"),
         sex = case_when(sdb$`Age-Sex of Focal` == "Adult Female" ~ "female",
                         sdb$`Age-Sex of Focal` == "Adol Female" ~ "female",
                         sdb$`Age-Sex of Focal` == "Flanged" ~ "male",
                         TRUE ~ "male")) -> sdb
# variable selection
sdb %>% 
  select(AveSDBEventID, 
         age, 
         sex, 
         `Social Y or N`,
         `Focal Orangutan ID`,
         `Event ID`,
         `SDB Rate`) -> mix_sdb
mix_sdb %>% 
  mutate(`Social Y or N` = factor(mix_sdb$`Social Y or N`, levels = c("Y", "N")),
         `Focal Orangutan ID` = factor(mix_sdb$`Focal Orangutan ID`),
         `Event ID` = factor(mix_sdb$`Event ID`)) -> mix_sdb
# add a new column that converts the sdb rate to the count of sdb. 
mix_sdb %>% 
  mutate(SDB = `SDB Rate` *10) -> mix_sdb
```

# Modeling

- Fit mixed models to data

## Linear Mixed Models
```{r}

# random intercept of factor "Focal Orangutan ID" and "Event ID"

# starts with LMM
lmm.fit <- lmer(`SDB Rate` ~ age * sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb)
summary(lmm.fit)

```

# Generalized Linear Mixed Models
Based on the nature of data - count data, GLMMs are more appropriate.

## no social partners in model
```{r}
# count data - then try GLMM with a poisson 
# poi.fit <- glmer(SDB ~ age + sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb,family = poisson(link = "log"))

poi.fit <- glmer(SDB ~ age * sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb,family = poisson(link = "log"))
# Model failed to converge with max|grad| = 0.107969 (tol = 0.002, component 1)
# Model is nearly unidentifiable: very large eigenvalue
#  - Rescale variables?

summary(poi.fit)
```
- Model diagnostics
```{r}
check_overdispersion(poi.fit)
# Overdispersion test
# 
#        dispersion ratio =    1.292
#   Pearson's Chi-Squared = 1970.885
#                 p-value =  < 0.001
# 
# Overdispersion detected.


check_zeroinflation(poi.fit)
# Check for zero-inflation
# 
#    Observed zeros: 1120
#   Predicted zeros: 1013
#             Ratio: 0.90

# Model is underfitting zeros (probable zero-inflation).


# comprehensive visualization of model checks
check_model(poi.fit)

# check model performance
performance(poi.fit)
```

- Found overdispersion and possible zero-inflation, so fit GLMM with a negative binomial distribution instead.

```{r}
# GLMM with a negative binomial distribution
nb.fit1 <-  glmer.nb(SDB ~ age + sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb)

nb.fit <-  glmer.nb(SDB ~ age * sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb)
# Model failed to converge with max|grad| = 0.107969 (tol = 0.002, component 1)
# Model is nearly unidentifiable: very large eigenvalue
#  - Rescale variables?
summary(nb.fit1)
summary(nb.fit)
# check overdispersion
check_overdispersion(nb.fit)

# sdb %>% distinct(`Focal Orangutan ID`)

# sdb %>% distinct(`Focal Orangutan ID`)


# comprehensive visualization of model checks
check_model(nb.fit)

# check model performance
performance(nb.fit) %>% tibble()
```

Now compare model performance
```{r}
mod.comparison <- compare_performance(poi.fit,nb.fit) %>% tibble()
mod.comparison

plot(compare_performance(poi.fit,nb.fit, rank = T))
# Error in datawizard::rescale(x, exclude = "Model", to = c(0.1, 1)) :
# lazy-load database '/Library/Frameworks/R.framework/Versions/4.2/Resources/library/datawizard/R/datawizard.rdb' is corrupt
```
Failed to converge - try Bayesian model
```{r}
library(rstanarm)
stan.poi.fit<- stan_glmer(SDB ~ age + sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb,family = poisson(link = "log"))
print(stan.poi.fit, digit = 3)
```
```{r}
stan.nb.fit<-stan_glmer.nb(SDB ~ age + sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb,link = "log")
print(stan.nb.fit, digit =3)
```


- when comparing poisson and negative binomial, consider residuals as the evaluation of which one would be better.


## add social partners

```{r}
poi.fit <- glmer(SDB ~ age * sex + `Social Y or N` + (1 | `Focal Orangutan ID`) + (1 | `Event ID`), data = mix_sdb,family = poisson(link = "log"))
```


## Wahlima only - model


